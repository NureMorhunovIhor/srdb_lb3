<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cars List</title>
    <link rel="stylesheet" href="/css/styles.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
</head>
<body>
<h1>Cars List</h1>

<!-- Button to trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#carModal" onclick="clearForm();">
    Add New Car
</button>
<button type="button" class="btn btn-secondary" onclick="window.location.href='/categories';">
    Categories
</button>
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead  class="table-dark">
        <tr>
            <th>Car Number</th>
            <th>Model</th>
            <th>Color</th>
            <th>Production Year</th>
            <th>Driver</th>
            <th>Category</th>
            <th>Max Passengers</th>
            <th>Kilometer Price</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="car : ${cars}">
            <td th:text="${car.carNumber}"></td>
            <td th:text="${car.model}"></td>
            <td th:text="${car.color}"></td>
            <td th:text="${car.productionYear}"></td>
            <td th:text="${car.driver != null ? car.driver.firstName + ' ' + car.driver.lastName : 'No Driver'}"></td>
            <td th:text="${car.carCategory != null ? car.carCategory.categoryName : 'No Category'}"></td>
            <td th:text="${car.carCategory != null ? car.carCategory.maxPassengersNumber : 'N/A'}"></td>
            <td th:text="${car.carCategory != null ? car.carCategory.kilometerPrice : 'N/A'}"></td>
            <td>
                <a href="#" class="btn btn-warning" th:attr="data-car-number=${car.carNumber}" onclick="populateEditModal(this.getAttribute('data-car-number')); return false;">Edit</a>
                <a th:href="@{/cars/delete/{carNumber}(carNumber=${car.carNumber})}" onclick="return confirm('Are you sure you want to delete this car?');" class="btn btn-danger">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal for adding/editing car -->
<div class="modal fade" id="carModal" tabindex="-1" aria-labelledby="carModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="carForm" th:action="@{/cars/add}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="carModalLabel">Create New Car</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="carNumber" class="form-label">Car Number</label>
                        <input type="text" class="form-control" id="carNumber" name="carNumber" required readonly/>
                    </div>
                    <div class="mb-3">
                        <label for="model" class="form-label">Model</label>
                        <input type="text" class="form-control" id="model" name="model" required>
                    </div>
                    <div class="mb-3">
                        <label for="color" class="form-label">Color</label>
                        <input type="text" class="form-control" id="color" name="color" required>
                    </div>
                    <div class="mb-3">
                        <label for="productionYear" class="form-label">Production Year</label>
                        <input type="number" class="form-control" id="productionYear" name="productionYear" required>
                    </div>
                    <div class="mb-3">
                        <label for="driverId" class="form-label">Driver</label>
                        <select class="form-select" id="driverId" name="driverId" required>
                            <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.firstName} + ' ' + ${driver.lastName}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryId" class="form-label">Category</label>
                        <select class="form-select" id="categoryId" name="carCategoryId" required>
                            <option th:each="category : ${carCategories}" th:value="${category.id}" th:text="${category.categoryName}"></option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Car</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js" defer></script>
<script>
    function populateEditModal(carNumber) {
        fetch(`/cars/edit/${carNumber}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Car not found or server error');
                }
                return response.json();
            })
            .then(car => {
                document.getElementById('carNumber').value = car.carNumber;
                document.getElementById('model').value = car.model;
                document.getElementById('color').value = car.color;
                document.getElementById('productionYear').value = car.productionYear;

                if (car.driver) {
                    document.getElementById('driverId').value = car.driver.id;
                } else {
                    document.getElementById('driverId').value = "";
                }
                if (car.carCategory) {
                    document.getElementById('categoryId').value = car.carCategory.id;
                } else {
                    document.getElementById('categoryId').value = "";
                }
                document.getElementById('carModalLabel').innerText = 'Edit Car';
                const carModal = new bootstrap.Modal(document.getElementById('carModal'));
                carModal.show();
            })
            .catch(error => {
                alert(error.message);
                console.error('Error:', error);
            });
    }

    function clearForm() {
        document.getElementById('carNumber').value = "";
        document.getElementById('carNumber').removeAttribute('readonly');
        document.getElementById('model').value = "";
        document.getElementById('color').value = "";
        document.getElementById('productionYear').value = "";
        document.getElementById('driverId').value = "";
        document.getElementById('categoryId').value = "";
        document.getElementById('carModalLabel').innerText = 'Create New Car';
    }
</script>
</body>
</html>
