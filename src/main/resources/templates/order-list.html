<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Order List</title>
  <link rel="stylesheet" href="/css/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
</head>
<body>
<div class="container">
  <h1>Orders</h1>

  <button id="addOrderBtn" type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#orderModal" onclick="clearOrderForm();">
    Add Order
  </button>

  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>From</th>
        <th>To</th>
        <th>Price</th>
        <th>State</th>
        <th>Driver</th>
        <th>Passenger</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="order : ${orders}">
        <td th:text="${order.id}"></td>
        <td th:text="${order.adressFrom}"></td>
        <td th:text="${order.adressTo}"></td>
        <td th:text="${order.price}"></td>
        <td th:text="${order.orderState}"></td>
        <td th:text="${order.driver != null ? order.driver.firstName + ' ' + order.driver.lastName : 'No Driver'}"></td>
        <td th:text="${order.passenger != null ? order.passenger.firstName + ' ' + order.passenger.lastName : 'No Passenger'}"></td>
        <td>
          <a href="#" class="btn btn-warning" th:onclick="'openOrderModal(' + ${order.id} + '); return false;'">Edit</a>
          <a th:href="@{/orders/delete/{id}(id=${order.id})}" class="btn btn-danger">Delete</a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="orderForm" action="/orders/add" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="orderModalTitle">Add Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="orderId" name="id"/>

          <div class="mb-3">
            <label for="adressFrom" class="form-label">From:</label>
            <input type="text" class="form-control" id="adressFrom" name="adressFrom" required>
          </div>

          <div class="mb-3">
            <label for="adressTo" class="form-label">To:</label>
            <input type="text" class="form-control" id="adressTo" name="adressTo" required>
          </div>

          <div class="mb-3">
            <label for="price" class="form-label">Price:</label>
            <input type="number" class="form-control" id="price" name="price" required>
          </div>

          <div class="mb-3">
            <label for="orderState" class="form-label">State:</label>
            <input type="text" class="form-control" id="orderState" name="orderState" required>
          </div>

          <div class="mb-3">
            <label for="driverId" class="form-label">Driver:</label>
            <select class="form-select" id="driverId" name="driverId" required>
              <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.firstName + ' ' + driver.lastName}"></option>
            </select>
          </div>

          <div class="mb-3">
            <label for="passengerId" class="form-label">Passenger:</label>
            <select class="form-select" id="passengerId" name="passengerId" required>
              <option th:each="passenger : ${passengers}" th:value="${passenger.id}" th:text="${passenger.firstName + ' ' + passenger.lastName}"></option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js" defer></script>
<script>
  function openOrderModal(id) {
    fetch(`/orders/edit/${id}`)
            .then(response => response.json())
            .then(order => {
              document.getElementById('orderId').value = order.id;
              document.getElementById('adressFrom').value = order.adressFrom;
              document.getElementById('adressTo').value = order.adressTo;
              document.getElementById('price').value = order.price;
              document.getElementById('orderState').value = order.orderState;
              document.getElementById('driverId').value = order.driver?.id || "";
              document.getElementById('passengerId').value = order.passenger?.id || "";
              document.getElementById('orderModalTitle').innerText = 'Edit Order';
              new bootstrap.Modal(document.getElementById('orderModal')).show();
            })
            .catch(error => console.error('Error fetching order:', error));
  }

  function clearOrderForm() {
    document.getElementById('orderForm').reset();
    document.getElementById('orderId').value = "";
    document.getElementById('orderModalTitle').innerText = 'Add Order';
  }
</script>
</body>
</html>
